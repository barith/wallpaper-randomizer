name: Build macOS Application

on:
  # Trigger on pushes to main branch and new tags
  push:
    branches:
      - main
    tags:
      - 'v*'
    paths-ignore:
      - '**.md'
      - '.gitignore'
  
  # Allow manual triggering from GitHub UI
  workflow_dispatch:
    inputs:
      version:
        description: 'Version string (optional)'
        required: false
        default: ''

jobs:
  build:
    name: Build macOS Application
    runs-on: macos-latest
    permissions:
      contents: write  # Required to create releases
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Build .app bundle with PyInstaller
        run: |
          pyinstaller wallpaper_randomizer_gui_macos.spec
      
      - name: Get version info
        id: version
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=$(date +'%Y%m%d-%H%M%S')-$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT
          fi
      
      - name: Install create-dmg
        run: |
          brew install create-dmg
      
      - name: Create DMG
        run: |
          # Create a temporary directory for DMG contents
          mkdir -p dmg-temp
          cp -r dist/WallpaperRandomizer.app dmg-temp/
          cp config.yaml.template dmg-temp/
          cp README.md dmg-temp/
          
          # Create instructions file
          cat > dmg-temp/INSTRUCTIONS.txt << 'EOF'
          Wallpaper Randomizer - macOS Distribution
          
          INSTALLATION:
          1. Drag WallpaperRandomizer.app to your Applications folder
          2. Copy config.yaml.template to config.yaml
          3. Edit config.yaml with your Reddit API credentials
             (See README.md Quick Start step 2 for instructions)
          4. Double-click WallpaperRandomizer.app to run
          
          FIRST RUN:
          If you see "unidentified developer" warning:
          1. Right-click the app and select "Open"
          2. Click "Open" in the dialog
          3. This only needs to be done once
          
          The app will look for config.yaml in the same directory as the .app bundle.
          EOF
          
          # Create DMG
          create-dmg \
            --volname "Wallpaper Randomizer" \
            --volicon "dmg-temp/WallpaperRandomizer.app/Contents/Resources/icon-windowed.icns" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "WallpaperRandomizer.app" 200 190 \
            --hide-extension "WallpaperRandomizer.app" \
            --app-drop-link 600 185 \
            --no-internet-enable \
            "WallpaperRandomizer-macOS-${{ steps.version.outputs.version }}.dmg" \
            "dmg-temp/" || \
          # Fallback if create-dmg fails (e.g., no icon file)
          create-dmg \
            --volname "Wallpaper Randomizer" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "WallpaperRandomizer.app" 200 190 \
            --hide-extension "WallpaperRandomizer.app" \
            --app-drop-link 600 185 \
            --no-internet-enable \
            "WallpaperRandomizer-macOS-${{ steps.version.outputs.version }}.dmg" \
            "dmg-temp/"
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: WallpaperRandomizer-macOS-${{ steps.version.outputs.version }}
          path: WallpaperRandomizer-macOS-${{ steps.version.outputs.version }}.dmg
          retention-days: 30
      
      - name: Create Release
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v1
        with:
          files: WallpaperRandomizer-macOS-${{ steps.version.outputs.version }}.dmg
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
